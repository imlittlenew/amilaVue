<!DOCTYPE html>
<html lang="en">

<head>
  <link href="img/logo.png" rel="shortcut icon" />
  <title>AMILA</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/login-signup.css" rel="stylesheet">
  <link href="css/mycss.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="js/NavigationBar.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>

</head>

<body>
  <div id="app" >
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" >
          <div class="toast-body d-flex justify-content-between align-items-center my-2">
              <h5 class="my-2 ms-3 fw-bolder">{{ toastMessage }}</h5>
              <button type="button" class="btn-close mx-3" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
      </div>
    </div>
    <button @click="scrollToTop" id="backToTopBtn" title="回到頂部"></button>
    <!-- 優惠訊息 -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary p-2" data-bs-theme="dark">
      <div class="container text-center">
        <div class="row mx-auto">
          <div class="col-12 ">
            <span class="navbar-brand mb-0 fs-6 text-light"><b>{{PromotionalMessage}}</b></span>
          </div>
        </div>
      </div>
    </nav>
    <!-- 導覽列 -->
    <div id="navigation"></div>
    <success-alert v-if="successMessage" :message="successMessage"></success-alert>
    <div class="row mb-5">
      <div class="col-md-6 order-2 order-md-1">
        <h1 class="text-center mt-5"><b>會員專區</b></h1>
        <!-- 登入表單開始 -->
        <main class="form-signin w-100 m-auto" id="loginForm" v-show="loginFormVisible">
          <form id="loginFormElement" @submit.prevent="submitLoginForm">
            <h1 class="h3 mb-3 fw-normal text-center">登入</h1>
            <div class="form-floating">
              <input type="email" class="form-control" id="loginEmail" name="email" autocomplete="username" placeholder="name@example.com" autocomplete="username" required>
              <label for="loginEmail">Email address</label>
            </div>
            <div class="form-floating">
              <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Password" minlength="8" autocomplete="current-password" required>
              <label for="loginPassword">Password</label>
            </div>
            <div class="form-check text-start my-3 d-flex justify-content-between">
              <label class="form-check-label" for="loginFlexCheckDefault">
                <input class="form-check-input me-2" type="checkbox" value="remember-me" id="loginFlexCheckDefault">
                <span>記住帳號</span>
              </label>
              <button type="button" @click="toggleForm('forgotPasswordForm')" class="text-end align-self-center dark-link"  id="toggleforgot">忘記密碼?</button>
            </div>
            <button @click="submitLoginForm()" class="btn btn-dark w-100 py-2 rounded-pill" type="submit">登入</button>
            <p class="mt-5 mb-3 text-body-secondary text-center">沒有 AMILA 帳戶?<button @click="toggleForm('registerForm')" id="toggleRegister"
                class="dark-link">免費註冊!</button></p>
          </form>
        </main>
        <!-- 登入表單結束 -->
        <!-- 註冊表單開始 -->
        <main class="form-signin w-100 m-auto" id="registerForm" v-show="registerFormVisible">
          <form id="registerFormElement" @submit.prevent="submitRegisterForm">
            <h1 class="h3 mb-3 fw-normal text-center">註冊</h1>

            <div class="form-floating">
              <input type="email" class="form-control" id="registerEmail" name="email" autocomplete="username" placeholder="name@example.com" autocomplete="username" required>
              <label for="registerEmail">Email address</label>
            </div>
            <div class="form-floating">
              <input type="password" class="form-control" id="registerPassword" name="password" placeholder="Password" minlength="8" autocomplete="current-password"
                required>
              <label for="registerPassword">Password</label>
            </div>
            <div class="form-check text-start my-3">
              <input class="form-check-input" type="checkbox" value="remember-me" id="registerFlexCheckDefault">
              <label class="form-check-label" for="registerFlexCheckDefault">
                我想接收有關產品和促銷活動的最新資訊。
              </label>
            </div>
            <button @click="submitRegisterForm()" class="btn btn-dark w-100 py-2 rounded-pill" type="submit">建立帳戶</button>
            <p class="mt-5 mb-3 text-body-secondary text-center">已經有帳戶?<button @click="toggleForm('loginForm')" id="toggleLogin"
                class="dark-link">登入</button></p>
          </form>
        </main>
        <!-- 註冊表單結束 -->
        <!-- 忘記密碼開始  -->
        <main class="form-signin w-100 m-auto" id="forgotPasswordForm" v-show="forgotPasswordFormVisible">
          <form @submit.prevent="submitforgotPasswordForm">
            <h1 class="h3 mb-3 fw-normal text-center mb-5">忘記密碼?</h1>
            <div class="form-floating">
              <input type="email" class="form-control" id="forgotPasswordEmail" name="email" autocomplete="username" placeholder="請輸入使用者名稱或電子郵件地址" required @keyup.enter="submitForgotPasswordForm">
              <label for="forgotPasswordEmail">請輸入電子郵件地址</label>
            </div>
            <button @click="submitForgotPasswordForm()" class="btn btn-dark w-100 py-2 mt-5 rounded-pill" type="submit">重新設定密碼</button>
          </form>
        </main>
        <!-- 忘記密碼結束 -->
      </div>
      <div class="col-md-6 order-1 order-md-2">
        <div ><img src="img/login-signup.png" class="bg-img"></a></div>
      </div>
    </div>
    <!-- 我的頁尾開始 -->
    <template>
      <Footer>
        <div class="b-example-divider"></div>
        <div class="mt-5 p-4 text-white text-center " style="background-image: url('img/footer.png');" data-bs-theme="dark">
          <div class="container  mt-5">
            <footer class="py-5 mt-5">
              <div class="row  mt-5 ">
                <div class="col-6  mb-3">
                  <ul class="nav flex-column">
                    <li class="nav-item mb-2 text-start">
                      <h5><b>聯絡我們</b></h5>
                    </li>
                    <br>
                    <li class="nav-item mb-2 text-start">
                      <h6>營業時間｜{{ businessHours }}</h6>
                    </li>
                    <li class="nav-item mb-2 text-start">
                      <h6>地址｜{{ address }}</h6>
                    </li>
                    <li class="nav-item mb-2 text-start">
                      <h6>客服信箱｜{{ email }}</h6>
                    </li>
                    <li class="nav-item mb-2 text-start">
                      <h6>客服電話｜{{ phone }}</h6>
                    </li>
                  </ul>
                </div>
                <div class="col-md-6 ">
                  <form>
                    <div class="text-start">
                      <h5><b>訂閱電子報</b></h5>
                    </div>
                    <div class="input-group mb-3">
                      <label class="visually-hidden">訂閱電子報信箱</label>
                      <input type="text" class="form-control rounded-start" placeholder="訂閱電子報信箱"
                        aria-label="Recipient's username" aria-describedby="button-addon2">
                      <button class="btn btn-outline-light " type="button" id="button-addon2">訂閱</button>
                    </div>
                    <div>
                      <ul class="list-unstyled d-flex">
                        <li class="ms-0"><img src="img/JCB.png" class="img-fluid img-thumbnail" alt="..."></a></li>
                        <li class="ms-0"><img src="img/VISA.png" class="img-fluid img-thumbnail" alt="..."></a></li>
                        <li class="ms-0"><img src="img/MasterCard.png" class="img-fluid img-thumbnail" alt="..."></a></li>
                      </ul>
                    </div>
                  </form>
                </div>
              </div>
              <div class="d-flex flex-column flex-sm-row justify-content-between py-4 my-4 border-top">
                <p>&copy; {{ currentYear }} 阿米拉工作室股份有限公司</p>
              </div>
            </footer>
          </div>
        </div>
      </Footer>
    </template>
    <!-- 我的頁尾結束 -->
  </div>

  <script>
    Vue.component('success-alert', {
      props: ['message'],
      template: `
        <div id="SuccessAlert" class="d-flex align-items-center">
          {{ message }}
          <div class="spinner-grow spinner-grow-sm mx-2" role="status">
            <div class="visually-hidden">Loading...</div>
          </div>
          <div class="spinner-grow spinner-grow-sm me-2" role="status">
            <div class="visually-hidden">Loading...</div>
          </div>
          <div class="spinner-grow spinner-grow-sm" role="status">
            <div class="visually-hidden">Loading...</div>
          </div>
        </div>
      `
    });
    new Vue({
      el: '#app',
      data() {
        return {
          PromotionalMessage: '歡慶阿米拉品牌月！全館 $599 享免運！',
          businessHours: "周一至周五 09：00 - 16：30",
          address: "臺中市南屯區公益路二段51號(國泰公益大樓)",
          email: "amila@gmail.com",
          phone: "(04)2242-1717 #263",
          currentYear: new Date().getFullYear(),
          loginFormVisible: true, // 登入表單的顯示狀態
          registerFormVisible: false, // 註冊表單的顯示狀態
          forgotPasswordFormVisible: false, // 忘記密碼表單的顯示狀態
          successMessage: '',
          email: '',
          password: '',
          toastMessage: '',
        };
      },
      methods: {
        loginSuccess(userData) {
          localStorage.setItem('isLoggedIn', true);
          localStorage.setItem('userData', JSON.stringify(userData));
        },
        showToast(message) {
            this.toastMessage = message;
            $('#liveToast').toast('show');
        },
        // 根據傳入的表單名稱來切換表單的可見性
        toggleForm(form) {
          switch (form) {
            case 'loginForm':
              this.loginFormVisible = true;
              this.registerFormVisible = false;
              this.forgotPasswordFormVisible = false;
              break;
            case 'registerForm':
              this.loginFormVisible = false;
              this.registerFormVisible = true;
              this.forgotPasswordFormVisible = false;
              break;
            case 'forgotPasswordForm':
              this.loginFormVisible = false;
              this.registerFormVisible = false;
              this.forgotPasswordFormVisible = true;
              break;
            default:
              break;
          }
        },
        handleSuccess(type) {
          switch (type) {
            case 'login':
              this.successMessage = '登入成功';
              break;
            case 'register':
              this.successMessage = '註冊成功';
              break;
            case 'forgotPassword':
              this.successMessage = '發送郵件成功';
              break;
            default:
              this.successMessage = '';
          }

          // 三秒後清除successMessage，進行不同頁面跳轉
          setTimeout(() => {
            this.successMessage = '';
            switch (type) {
              case 'login':
                window.location.href = 'index.html';
                break;
              case 'register':
                window.location.href = 'user.html';
                break;
              case 'forgotPassword':
                window.location.href = 'user.html';
                break;
              default:
                break;
            }
          }, 1500);
        },
        handleScroll() {
          // 滾動事件處理程序
          let prevScrollpos = window.pageYOffset;
          let backToTopBtn = document.getElementById("backToTopBtn");
          window.addEventListener("scroll", () => {
            let currentScrollPos = window.pageYOffset;
            if ((currentScrollPos > 100 && currentScrollPos !== 0) && prevScrollpos > currentScrollPos) {
              // 判斷是否顯示回到頂部按鈕
              backToTopBtn.style.opacity = "1";
            } else {
              backToTopBtn.style.opacity = "0";
            }
            prevScrollpos = currentScrollPos;
          });
          backToTopBtn.addEventListener("click", () => {
            this.scrollToTop();
          });
        },
        scrollToTop() {
          window.scrollTo({
            top: 0,
            behavior: "smooth"
          });
        },
        // 提交忘記密碼表單
        submitForgotPasswordForm() {
          const email = $('#forgotPasswordEmail').val();
          if (email !== '') {
            if (this.isValidEmail(email)) {
              fetch('http://localhost:8000/forgotPassword', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
              })
              .then(response => {
                if (response.ok) {
                  this.handleSuccess('forgotPassword');
                } else {
                  response.text().then(errorMessage => {
                    this.showToast(errorMessage);
                  });
                }
              })
              .catch(error => {
                this.showToast('發生錯誤，請稍後再試！');
              });
            } else {
              this.showToast('電子郵件格式不正確！');
            }
          } else {
            this.showToast('電子郵件不能為空！');
          }
        },

        // 提交註冊表單
        submitRegisterForm() {
          const email = $('#registerEmail').val();
          const password = $('#registerPassword').val();
          if (email !== '') {
            if (this.isValidEmail(email)) {
              if (password !== '') {
                if (this.isValidPassword(password)) {
                  fetch('http://localhost:8000/register', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                  })
                  .then(response => {
                    if (response.ok) {
                      this.handleSuccess('register');
                    } else {
                      this.showToast('會員已存在');
                    }
                  })
                  .catch(error => {
                    this.showToast('註冊失敗');
                  });
                } else {
                  this.showToast('密碼至少八位，包含一個大寫字母和一個小寫字母！');
                }
              } else {
                this.showToast('密碼不能為空！');
              }
            } else {
              this.showToast('電子郵件格式不正確！');
            }
          } else {
            this.showToast('電子郵件不能為空！');
          }
        },
        // 提交登入表單
        submitLoginForm() {
          const email = $('#loginEmail').val();
          const password = $('#loginPassword').val();
          if (email !== '') {
            if (this.isValidEmail(email)) {
              if (password !== '') {
                if (this.isValidPassword(password)) {
                  fetch('http://localhost:8000/login', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                  })
                  .then(response => {
                    if (response.ok) {
                      return response.json();
                    } else {
                      throw new Error('帳號或密碼錯誤');
                    }
                  })
                  .then(data => {
                    this.handleSuccess('login');
                    this.loginSuccess(data);
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    this.showToast(error.message);
                  });

                } else {
                  this.showToast('密碼至少八位，包含一個大寫字母和一個小寫字母！');
                }
              } else {
                this.showToast('密碼不能為空！');
              }
            } else {
              this.showToast('電子郵件格式不正確！');
            }
          } else {
            this.showToast('電子郵件不能為空！');
          }
        },
        // 驗證郵件地址
        isValidEmail(email) {
          const emailPattern = /\S+@\S+\.\S+/;
          return emailPattern.test(email);
        },
        isValidPassword(password) {
        const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z]).{8,}$/;
        return passwordPattern.test(password);
        }
      }  
    });
  </script>
  <script>
    const navigationElement = document.getElementById('navigation');
    new Vue({
      render: h => h(NavigationBar)
    }).$mount(navigationElement);
  </script>
</body>

</html>